<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Manage Secrets in NixOS | sekun's blog</title>
<meta name=keywords content="nix,flakes">
<meta name=description content="Recently, I experimented with running NixOS on a DigitalOcean droplet (which I will probably write about in the future), and migrated some of my toy projects from App Platform. During the migration process, I realized that I would have to somehow handle the DB certificate, and other sensitive credentials. I can&rsquo;t just hardcode these!
One of the more popular projects for problems like this is agenix. Their README for how to use it was a bit confusing (for me) so hopefully this post will be of use to others.">
<meta name=author content="sekun">
<link rel=canonical href=https://blog.sekun.dev/posts/manage-secrets-in-nixos/>
<link rel=preconnect href=https://fonts.googleapis.com>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Vollkorn:wght@400;500;600;700&display=swap" rel=stylesheet>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.c5fdf02d9fbdbf20a5d2f0688981e299eed4e35afd7c8b5989b9d6c8f9944a14.css integrity="sha256-xf3wLZ+9vyCl0vBoiYHime7U41r9fItZibnWyPmUShQ=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.sekun.dev/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://blog.sekun.dev/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://blog.sekun.dev/favicon-32x32.png>
<link rel=apple-touch-icon href=https://blog.sekun.dev/apple-touch-icon.png>
<link rel=mask-icon href=https://blog.sekun.dev/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript><meta property="og:title" content="Manage Secrets in NixOS">
<meta property="og:description" content="Recently, I experimented with running NixOS on a DigitalOcean droplet (which I will probably write about in the future), and migrated some of my toy projects from App Platform. During the migration process, I realized that I would have to somehow handle the DB certificate, and other sensitive credentials. I can&rsquo;t just hardcode these!
One of the more popular projects for problems like this is agenix. Their README for how to use it was a bit confusing (for me) so hopefully this post will be of use to others.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.sekun.dev/posts/manage-secrets-in-nixos/">
<meta property="og:image" content="https://blog.sekun.dev/posts/p4-cover.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-10-27T12:31:00+00:00">
<meta property="article:modified_time" content="2022-10-27T12:31:00+00:00">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://blog.sekun.dev/posts/p4-cover.png">
<meta name=twitter:title content="Manage Secrets in NixOS">
<meta name=twitter:description content="Recently, I experimented with running NixOS on a DigitalOcean droplet (which I will probably write about in the future), and migrated some of my toy projects from App Platform. During the migration process, I realized that I would have to somehow handle the DB certificate, and other sensitive credentials. I can&rsquo;t just hardcode these!
One of the more popular projects for problems like this is agenix. Their README for how to use it was a bit confusing (for me) so hopefully this post will be of use to others.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://blog.sekun.dev/posts/"},{"@type":"ListItem","position":3,"name":"Manage Secrets in NixOS","item":"https://blog.sekun.dev/posts/manage-secrets-in-nixos/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Manage Secrets in NixOS","name":"Manage Secrets in NixOS","description":"Recently, I experimented with running NixOS on a DigitalOcean droplet (which I will probably write about in the future), and migrated some of my toy projects from App Platform. During the migration process, I realized that I would have to somehow handle the DB certificate, and other sensitive credentials. I can\u0026rsquo;t just hardcode these!\nOne of the more popular projects for problems like this is agenix. Their README for how to use it was a bit confusing (for me) so hopefully this post will be of use to others.","keywords":["nix","flakes"],"articleBody":"Recently, I experimented with running NixOS on a DigitalOcean droplet (which I will probably write about in the future), and migrated some of my toy projects from App Platform. During the migration process, I realized that I would have to somehow handle the DB certificate, and other sensitive credentials. I can’t just hardcode these!\nOne of the more popular projects for problems like this is agenix. Their README for how to use it was a bit confusing (for me) so hopefully this post will be of use to others.\nThere are two parts to this post: 1) creating secrets with agenix, and 2) reading said secrets in a remote NixOS server. Of course you could use it for different things, and my example isn’t exactly the simplest.\n Note: I’m not saying this is the best way to do things. Please let me know if there are any glaring issues you find!\n Prerequisites Here’s a checklist for what’s needed:\n agenix CLI present in your computer agenix’s module to the system you want secrets to be read in An SSH key pair present in the machine you’ll create the secrets in as well as in the machine you want the secrets to be read in  Installing agenix is documented well in their README so feel free to consult it.\nAbout agenix Age files Secrets are encrypted and stored by agenix in these things called age files. These files have the .age format which is created by the agenix CLI. For you to create an age file, the CLI looks for a secrets.nix file in the current directory for the rules to determine who is allowed to decrypt it.\nSo, what are these rules?\nRules Let’s see what the agenix CLI says:\n$ agenix agenix - edit and rekey age secret files agenix -e FILE [-i PRIVATE_KEY] agenix -r [-i PRIVATE_KEY] options: -h, --help show help -e, --edit FILE edits FILE using $EDITOR -r, --rekey re-encrypts all secrets with specified recipients -i, --identity identity to use when decrypting -v, --verbose verbose output FILE an age-encrypted file PRIVATE_KEY a path to a private SSH key used to decrypt file EDITOR environment variable of editor to use when editing FILE RULES environment variable with path to Nix file specifying recipient public keys. Defaults to './secrets.nix' agenix version: 0.13.0 age binary path: /nix/store/kfasn0129ac0xn8wfvf7mq38rxhbc725-rage-0.8.1/bin/rage age version: rage 0.8.1 Specifically:\n RULES environment variable with path to Nix file specifying recipient public keys. Defaults to ‘./secrets.nix’\n In the aforementioned file, we’re able to say whose key can decrypt what age file. Let’s create this file first.\n# We'll store the rules, and age files in the `secrets` folder mkdir secrets touch secrets.nix For the example later, I’ll need two files: one containing the DB CA certificate, and the DB password. So I’ll create a rule for each age file I’m going to generate later on.\nHere’s how it looks like:\n# secrets/secrets.nix let peepeepoopoo = \"ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIB/Oxx/jZS7TRqjp2kwaYavzcxxKFTrStikFrtZq3q3l root@peepeepoopoo\"; in { \"emojiedDBPassword.age\".publicKeys = [ peepeepoopoo ]; \"emojiedDBCACert.age\".publicKeys = [ peepeepoopoo ]; } When decrypting/creating emojiedDBPassword.age for example, agenix looks for the private key pair of the public key that was supplied. Otherwise, it prohibits the user from doing so, and will complain about there not being any matching keys.\n Note: You don’t need the rules file for decrypting an age file because the permissions are already encoded in the age file. You should only have it present if you’re using the CLI for creating/updating an age file.\n Creating a secret We’ll need the agenix CLI to create an age file containing our encrypted secret, and run this:\n$ agenix -e emojiedDBCACert.age This opens a text editor for you to put the secret in.\n  Updating a secret’s public keys If you need to add public keys for existing age files, update the secrets.nix file accordingly, and run agenix -r. Make sure you’re in the same directory as the secrets.nix, and age files.\nIt would show you something like this if it succeeds:\nsekun@ichi /s/S/d/secrets (main) agenix -r rekeying emojiedDBCACert.age... rekeying emojiedDBPassword.age... Now our age files are ready to be used!\nReading secrets in Nix I mentioned earlier that my use case is for supplying the DB CA certificate, and DB password to the emojied app for it to connect with the DB properly. I won’t get into the details of how I set up the server. Rather, I’ll just include the parts necessary. If you wish to read the full config files, check the repo although peepeepoopoo here is a throwaway server. Hence not in the repo.\nWhat I need in the remote server called peepeepoopoo (where emojied is running) are the ff:\n agenix NixOS module Age files SSH key permitted to decrypt said age files  flake.nix:\n{ description = \"Example\"; inputs = { nixpkgs.url = \"github:NixOS/nixpkgs/nixos-22.05\"; emojiedpkg.url = \"github:sekunho/emojied\"; agenix.url = \"github:ryantm/agenix\"; }; outputs = { self, nixpkgs, emojiedpkg, agenix }: let system = \"x86_64-linux\"; pkgs = nixpkgs.legacyPackages.${system}; emojied = emojiedpkg.packages.${system}.emojied; in { nixosConfigurations.peepeepoopoo = nixpkgs.lib.nixosSystem { inherit system; modules = [ emojiedpkg.nixosModule ./hosts/peepeepoopoo/configuration.nix agenix.nixosModules.age ]; # Applies the configuration.nix function to these arguments specialArgs = { inherit pkgs; inherit emojied; }; }; }; } All that’s left to do is specify where the age files are located, and referencing the decrypted age files' paths.\nhosts/peepeepoopoo/configuration.nix:\n{ modulesPath, lib, config, pkgs, ... }: { imports = lib.optional (builtins.pathExists ./do-userdata.nix) ./do-userdata.nix ++ [ (modulesPath + \"/virtualisation/digital-ocean-config.nix\") ]; programs.ssh = { startAgent = true; extraConfig = '' AddKeysToAgent yes ''; }; nix = { package = pkgs.nixVersions.nix_2_9; extraOptions = '' experimental-features = nix-command flakes ''; settings.trusted-public-keys = [ \"hydra.iohk.io:f/Ea+s+dFdN+3Y/G+FDgSq+a5NEWhJGzdjvKNGv0/EQ=\" \"iohk.cachix.org-1:DpRUyj7h7V830dp/i6Nti+NEO2/nhblbov/8MW7Rqoo=\" \"nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=\" ]; settings.substituters = [ \"https://cache.iog.io\" \"https://iohk.cachix.org\" \"https://nix-community.cachix.org\" ]; }; age = { # We're letting `agenix` know where the locations of the age files will be # in the server. secrets = { emojiedDBPassword.file = \"/root/secrets/emojiedDBPassword.age\"; emojiedDBCACert.file = \"/root/secrets/emojiedDBCACert.age\"; }; # Private key of the SSH key pair. This is the other pair of what was supplied # in `secrets.nix`. # # This tells `agenix` where to look for the private key. identityPaths = [ \"/root/.ssh/id_ed25519\" ]; }; # List services that you want to enable: services = { emojied = { enable = true; port = \"3000\"; dbHost = \"\"; dbName = \"\"; dbPort = \"\"; dbUser = \"\"; dbPoolSize = \"5\"; dbPasswordFile = config.age.secrets.emojiedDBPassword.path; dbCACertFile = config.age.secrets.emojiedDBCACert.path; }; openssh = { enable = true; permitRootLogin = \"prohibit-password\"; passwordAuthentication = false; }; }; networking = { firewall = { enable = true; allowedTCPPorts = [ 22 3000 ]; }; }; # List packages installed in system profile. To search, run: # $ nix search wget environment = { systemPackages = with pkgs; []; loginShellInit = '' export SSH_AUTH_SOCK=\"$XDG_RUNTIME_DIR/ssh-agent.socket\" ''; }; system.stateVersion = \"22.05\"; } Now we can move the secrets folder, and the SSH key (if it’s not already there) from our host machine to the remote server.\n$ scp secrets root@:/root/ $ scp ~/.ssh/ root@:/root/.ssh/id_ed25519 $ scp ~/.ssh/.pub root@:/root/.ssh/id_ed25519.pub Then hit build and apply the config:\n$ nixos-rebuild switch \\ --flake .#peepeepoopoo \\ --target-host root@ \\ --build-host localhost copying 3 paths... copying path '/nix/store/lali119kww58c4df3b1w61yzg5an1mr7-system-units' to 'ssh://root@'... copying path '/nix/store/g1izspgbn34hmlll2hby5qapx90nm43p-etc' to 'ssh://root@'... copying path '/nix/store/739zphavd4d1vjfnd8v2b1bpm0dzwxz6-nixos-system-unnamed-22.05.20221024.6107f97' to 'ssh://root@'... updating GRUB 2 menu... stopping the following units: emojied.service activating the configuration... [agenix] creating new generation in /run/agenix.d/1 [agenix] decrypting secrets... decrypting '/root/secrets/emojiedDBCACert.age' to '/run/agenix.d/1/emojiedDBCACert'... decrypting '/root/secrets/emojiedDBPassword.age' to '/run/agenix.d/1/emojiedDBPassword'... [agenix] symlinking new secrets to /run/agenix (generation 1)... [agenix] chowning... setting up /etc... reloading user units for root... setting up tmpfiles starting the following units: emojied.service the following new units were started: run-agenix.d.mount Which gives me this beautiful creation:\n  The abomination now works!\n  ","wordCount":"1259","inLanguage":"en","image":"https://blog.sekun.dev/posts/p4-cover.png","datePublished":"2022-10-27T12:31:00Z","dateModified":"2022-10-27T12:31:00Z","author":{"@type":"Person","name":"sekun"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.sekun.dev/posts/manage-secrets-in-nixos/"},"publisher":{"@type":"Organization","name":"sekun's blog","logo":{"@type":"ImageObject","url":"https://blog.sekun.dev/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://blog.sekun.dev accesskey=h title="sekun's blog (Alt + H)">sekun's blog</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://blog.sekun.dev/posts/ title=posts>
<span>posts</span>
</a>
</li>
<li>
<a href=https://blog.sekun.dev/tags/ title=tags>
<span>tags</span>
</a>
</li>
<li>
<a href=https://blog.sekun.dev/archive/ title="search (Alt + /)" accesskey=/>
<span>search</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
Manage Secrets in NixOS
</h1>
<div class=post-meta><span title="2022-10-27 12:31:00 +0000 UTC">October 27, 2022</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;sekun&nbsp;|&nbsp;<a href=https://github.com/sekunho/sekun.dev/tree/main/blog/content/posts/manage-secrets-in-nixos/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div>
</header>
<figure class=entry-cover><img loading=lazy src=https://blog.sekun.dev/posts/p4-cover.png alt="An image of a lock and the NixOS logo beside each other">
<p>How to avoid hardcoding secrets in Nix</p>
</figure><div class=toc>
<details open>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#prerequisites aria-label=Prerequisites>Prerequisites</a></li>
<li>
<a href=#about-agenix aria-label="About agenix">About <code>agenix</code></a><ul>
<li>
<a href=#age-files aria-label="Age files">Age files</a></li>
<li>
<a href=#rules aria-label=Rules>Rules</a></li>
<li>
<a href=#creating-a-secret aria-label="Creating a secret">Creating a secret</a></li>
<li>
<a href=#updating-a-secrets-public-keys aria-label="Updating a secret&amp;rsquo;s public keys">Updating a secret&rsquo;s public keys</a></li></ul>
</li>
<li>
<a href=#reading-secrets-in-nix aria-label="Reading secrets in Nix">Reading secrets in Nix</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><p>Recently, I experimented with running NixOS on a DigitalOcean droplet (which I
will probably write about in the future), and migrated some of my toy projects
from App Platform. During the migration process, I realized that I would
have to somehow handle the DB certificate, and other sensitive credentials.
I can&rsquo;t just hardcode these!</p>
<p>One of the more popular projects for problems like this is
<a href=https://github.com/ryantm/agenix>agenix</a>. Their README for how to use it was
a bit confusing (for me) so hopefully this post will be of use to others.</p>
<p>There are two parts to this post: 1) creating secrets with <code>agenix</code>, and 2)
reading said secrets in a remote NixOS server. Of course you could use it for
different things, and my example isn&rsquo;t exactly the simplest.</p>
<blockquote>
<p><strong>Note</strong>: I&rsquo;m not saying this is the best way to do things. Please let me know
if there are any glaring issues you find!</p>
</blockquote>
<h1 id=prerequisites>Prerequisites<a hidden class=anchor aria-hidden=true href=#prerequisites>#</a></h1>
<p>Here&rsquo;s a checklist for what&rsquo;s needed:</p>
<ul>
<li><code>agenix</code> CLI present in your computer</li>
<li><code>agenix</code>&rsquo;s module to the system you want secrets to be read in</li>
<li>An SSH key pair present in the machine you&rsquo;ll create the secrets in as well as
in the machine you want the secrets to be read in</li>
</ul>
<p>Installing <code>agenix</code> is documented well in their README so feel free to consult
it.</p>
<h1 id=about-agenix>About <code>agenix</code><a hidden class=anchor aria-hidden=true href=#about-agenix>#</a></h1>
<h2 id=age-files>Age files<a hidden class=anchor aria-hidden=true href=#age-files>#</a></h2>
<p>Secrets are encrypted and stored by <code>agenix</code> in these things called <em>age files</em>.
These files have the <code>.age</code> format which is created by the <code>agenix</code> CLI. For
you to create an age file, the CLI looks for a <code>secrets.nix</code> file in the current
directory for the <em>rules</em> to determine who is allowed to decrypt it.</p>
<p>So, what are these rules?</p>
<h2 id=rules>Rules<a hidden class=anchor aria-hidden=true href=#rules>#</a></h2>
<p>Let&rsquo;s see what the <code>agenix</code> CLI says:</p>
<pre tabindex=0><code>$ agenix
agenix - edit and rekey age secret files

agenix -e FILE [-i PRIVATE_KEY]
agenix -r [-i PRIVATE_KEY]

options:
-h, --help                show help
-e, --edit FILE           edits FILE using $EDITOR
-r, --rekey               re-encrypts all secrets with specified recipients
-i, --identity            identity to use when decrypting
-v, --verbose             verbose output

FILE an age-encrypted file

PRIVATE_KEY a path to a private SSH key used to decrypt file

EDITOR environment variable of editor to use when editing FILE

RULES environment variable with path to Nix file specifying recipient public keys.
Defaults to './secrets.nix'

agenix version: 0.13.0
age binary path: /nix/store/kfasn0129ac0xn8wfvf7mq38rxhbc725-rage-0.8.1/bin/rage
age version: rage 0.8.1
</code></pre><p>Specifically:</p>
<blockquote>
<p>RULES environment variable with path to Nix file specifying recipient public keys.
Defaults to &lsquo;./secrets.nix&rsquo;</p>
</blockquote>
<p>In the aforementioned file, we&rsquo;re able to say whose key can decrypt what age file.
Let&rsquo;s create this file first.</p>
<pre tabindex=0><code># We'll store the rules, and age files in the `secrets` folder
mkdir secrets

touch secrets.nix
</code></pre><p>For the example later, I&rsquo;ll need two files: one containing the DB CA certificate,
and the DB password. So I&rsquo;ll create a rule for each age file I&rsquo;m going to generate
later on.</p>
<p>Here&rsquo;s how it looks like:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=color:#75715e># secrets/secrets.nix</span>

<span style=color:#66d9ef>let</span>
  peepeepoopoo <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIB/Oxx/jZS7TRqjp2kwaYavzcxxKFTrStikFrtZq3q3l root@peepeepoopoo&#34;</span>;
<span style=color:#66d9ef>in</span> {
  <span style=color:#e6db74>&#34;emojiedDBPassword.age&#34;</span><span style=color:#f92672>.</span>publicKeys <span style=color:#f92672>=</span> [ peepeepoopoo ];
  <span style=color:#e6db74>&#34;emojiedDBCACert.age&#34;</span><span style=color:#f92672>.</span>publicKeys <span style=color:#f92672>=</span> [ peepeepoopoo ];
}
</code></pre></div><p>When decrypting/creating <code>emojiedDBPassword.age</code> for example, <code>agenix</code> looks for
the private key pair of the public key that was supplied. Otherwise, it prohibits
the user from doing so, and will complain about there not being any matching keys.</p>
<blockquote>
<p><strong>Note</strong>: You don&rsquo;t need the rules file for decrypting an age file because the
permissions are already encoded in the age file. You should only have it present
if you&rsquo;re using the CLI for creating/updating an age file.</p>
</blockquote>
<h2 id=creating-a-secret>Creating a secret<a hidden class=anchor aria-hidden=true href=#creating-a-secret>#</a></h2>
<p>We&rsquo;ll need the <code>agenix</code> CLI to create an age file containing our encrypted secret,
and run this:</p>
<pre tabindex=0><code>$ agenix -e emojiedDBCACert.age
</code></pre><p>This opens a text editor for you to put the secret in.</p>
<figure>
<img loading=lazy src=/posts/p4-agenix-e.png>
</figure>
<h2 id=updating-a-secrets-public-keys>Updating a secret&rsquo;s public keys<a hidden class=anchor aria-hidden=true href=#updating-a-secrets-public-keys>#</a></h2>
<p>If you need to add public keys for existing age files, update the <code>secrets.nix</code>
file accordingly, and run <code>agenix -r</code>. Make sure you&rsquo;re in the same directory
as the <code>secrets.nix</code>, and age files.</p>
<p>It would show you something like this if it succeeds:</p>
<pre tabindex=0><code>sekun@ichi /s/S/d/secrets (main)&gt; agenix -r
rekeying emojiedDBCACert.age...
rekeying emojiedDBPassword.age...
</code></pre><p>Now our age files are ready to be used!</p>
<h1 id=reading-secrets-in-nix>Reading secrets in Nix<a hidden class=anchor aria-hidden=true href=#reading-secrets-in-nix>#</a></h1>
<p>I mentioned earlier that my use case is for supplying the DB CA certificate, and
DB password to the <a href=https://emojied.net><code>emojied</code></a> app for it to connect with
the DB properly. I won&rsquo;t get into the details of how I set up the server. Rather,
I&rsquo;ll just include the parts necessary. If you wish to read the full config files,
check the <a href=https://github.com/sekunho/dotfiles>repo</a> although <code>peepeepoopoo</code> here
is a throwaway server. Hence not in the repo.</p>
<p>What I need in the remote server called <code>peepeepoopoo</code> (where <code>emojied</code> is
running) are the ff:</p>
<ul>
<li><code>agenix</code> NixOS module</li>
<li>Age files</li>
<li>SSH key permitted to decrypt said age files</li>
</ul>
<p><code>flake.nix</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix>{
  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Example&#34;</span>;

  inputs <span style=color:#f92672>=</span> {
    nixpkgs<span style=color:#f92672>.</span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;github:NixOS/nixpkgs/nixos-22.05&#34;</span>;
    emojiedpkg<span style=color:#f92672>.</span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;github:sekunho/emojied&#34;</span>;
    agenix<span style=color:#f92672>.</span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;github:ryantm/agenix&#34;</span>;
  };

  outputs <span style=color:#f92672>=</span> {
    self<span style=color:#f92672>,</span>
    nixpkgs<span style=color:#f92672>,</span>
    emojiedpkg<span style=color:#f92672>,</span>
    agenix
  }:
    <span style=color:#66d9ef>let</span>
      system <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;x86_64-linux&#34;</span>;
      pkgs <span style=color:#f92672>=</span> nixpkgs<span style=color:#f92672>.</span>legacyPackages<span style=color:#f92672>.</span><span style=color:#e6db74>${</span>system<span style=color:#e6db74>}</span>;
      emojied <span style=color:#f92672>=</span> emojiedpkg<span style=color:#f92672>.</span>packages<span style=color:#f92672>.</span><span style=color:#e6db74>${</span>system<span style=color:#e6db74>}</span><span style=color:#f92672>.</span>emojied;
    <span style=color:#66d9ef>in</span> {
      nixosConfigurations<span style=color:#f92672>.</span>peepeepoopoo <span style=color:#f92672>=</span> nixpkgs<span style=color:#f92672>.</span>lib<span style=color:#f92672>.</span>nixosSystem {
        <span style=color:#66d9ef>inherit</span> system;

        modules <span style=color:#f92672>=</span> [
          emojiedpkg<span style=color:#f92672>.</span>nixosModule
          <span style=color:#e6db74>./hosts/peepeepoopoo/configuration.nix</span>
          agenix<span style=color:#f92672>.</span>nixosModules<span style=color:#f92672>.</span>age
        ];

        <span style=color:#75715e># Applies the configuration.nix function to these arguments</span>
        specialArgs <span style=color:#f92672>=</span> {
          <span style=color:#66d9ef>inherit</span> pkgs;
          <span style=color:#66d9ef>inherit</span> emojied;
        };
      };
    };
}
</code></pre></div><p>All that&rsquo;s left to do is specify where the age files are located, and referencing
the decrypted age files' paths.</p>
<p><code>hosts/peepeepoopoo/configuration.nix</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix>{ modulesPath<span style=color:#f92672>,</span> lib<span style=color:#f92672>,</span> config<span style=color:#f92672>,</span> pkgs<span style=color:#f92672>,</span> <span style=color:#f92672>...</span> }: {
  imports <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>optional (builtins<span style=color:#f92672>.</span>pathExists <span style=color:#e6db74>./do-userdata.nix</span>) <span style=color:#e6db74>./do-userdata.nix</span> <span style=color:#f92672>++</span> [
    (modulesPath <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/virtualisation/digital-ocean-config.nix&#34;</span>)
  ];

  programs<span style=color:#f92672>.</span>ssh <span style=color:#f92672>=</span> {
    startAgent <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;

    extraConfig <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;
</span><span style=color:#e6db74>      AddKeysToAgent yes
</span><span style=color:#e6db74>    &#39;&#39;</span>;
  };

  nix <span style=color:#f92672>=</span> {
    package <span style=color:#f92672>=</span> pkgs<span style=color:#f92672>.</span>nixVersions<span style=color:#f92672>.</span>nix_2_9;

    extraOptions <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;
</span><span style=color:#e6db74>      experimental-features = nix-command flakes
</span><span style=color:#e6db74>    &#39;&#39;</span>;

    settings<span style=color:#f92672>.</span>trusted-public-keys <span style=color:#f92672>=</span> [
      <span style=color:#e6db74>&#34;hydra.iohk.io:f/Ea+s+dFdN+3Y/G+FDgSq+a5NEWhJGzdjvKNGv0/EQ=&#34;</span>
      <span style=color:#e6db74>&#34;iohk.cachix.org-1:DpRUyj7h7V830dp/i6Nti+NEO2/nhblbov/8MW7Rqoo=&#34;</span>
      <span style=color:#e6db74>&#34;nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=&#34;</span>
    ];

    settings<span style=color:#f92672>.</span>substituters <span style=color:#f92672>=</span> [
      <span style=color:#e6db74>&#34;https://cache.iog.io&#34;</span>
      <span style=color:#e6db74>&#34;https://iohk.cachix.org&#34;</span>
      <span style=color:#e6db74>&#34;https://nix-community.cachix.org&#34;</span>
    ];
  };

  age <span style=color:#f92672>=</span> {
    <span style=color:#75715e># We&#39;re letting `agenix` know where the locations of the age files will be</span>
    <span style=color:#75715e># in the server.</span>
    secrets <span style=color:#f92672>=</span> {
      emojiedDBPassword<span style=color:#f92672>.</span>file <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/root/secrets/emojiedDBPassword.age&#34;</span>;
      emojiedDBCACert<span style=color:#f92672>.</span>file <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/root/secrets/emojiedDBCACert.age&#34;</span>;
    };

    <span style=color:#75715e># Private key of the SSH key pair. This is the other pair of what was supplied</span>
    <span style=color:#75715e># in `secrets.nix`.</span>
    <span style=color:#75715e>#</span>
    <span style=color:#75715e># This tells `agenix` where to look for the private key.</span>
    identityPaths <span style=color:#f92672>=</span> [ <span style=color:#e6db74>&#34;/root/.ssh/id_ed25519&#34;</span> ];
  };

  <span style=color:#75715e># List services that you want to enable:</span>
  services <span style=color:#f92672>=</span> {
    emojied <span style=color:#f92672>=</span> {
      enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
      port <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;3000&#34;</span>;
      dbHost <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;REPLACE_WITH_YOUR_OWN&gt;&#34;</span>;
      dbName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;REPLACE_WITH_YOUR_OWN&gt;&#34;</span>;
      dbPort <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;REPLACE_WITH_YOUR_OWN&gt;&#34;</span>;
      dbUser <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;REPLACE_WITH_YOUR_OWN&gt;&#34;</span>;
      dbPoolSize <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;5&#34;</span>;
      dbPasswordFile <span style=color:#f92672>=</span> config<span style=color:#f92672>.</span>age<span style=color:#f92672>.</span>secrets<span style=color:#f92672>.</span>emojiedDBPassword<span style=color:#f92672>.</span>path;
      dbCACertFile <span style=color:#f92672>=</span> config<span style=color:#f92672>.</span>age<span style=color:#f92672>.</span>secrets<span style=color:#f92672>.</span>emojiedDBCACert<span style=color:#f92672>.</span>path;
    };

    openssh <span style=color:#f92672>=</span> {
      enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
      permitRootLogin <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;prohibit-password&#34;</span>;
      passwordAuthentication <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
    };
  };

  networking <span style=color:#f92672>=</span> {
    firewall <span style=color:#f92672>=</span> {
      enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
      allowedTCPPorts <span style=color:#f92672>=</span> [ <span style=color:#ae81ff>22</span> <span style=color:#ae81ff>3000</span> ];
    };
  };

  <span style=color:#75715e># List packages installed in system profile. To search, run:</span>
  <span style=color:#75715e># $ nix search wget</span>
  environment <span style=color:#f92672>=</span> {
    systemPackages <span style=color:#f92672>=</span> <span style=color:#66d9ef>with</span> pkgs; [];

    loginShellInit <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;
</span><span style=color:#e6db74>      export SSH_AUTH_SOCK=&#34;$XDG_RUNTIME_DIR/ssh-agent.socket&#34;
</span><span style=color:#e6db74>    &#39;&#39;</span>;
  };

  system<span style=color:#f92672>.</span>stateVersion <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;22.05&#34;</span>;
}
</code></pre></div><p>Now we can move the <code>secrets</code> folder, and the SSH key (if it&rsquo;s not already there)
from our host machine to the remote server.</p>
<pre tabindex=0><code>$ scp secrets root@&lt;SERVER_IP&gt;:/root/
$ scp ~/.ssh/&lt;YOUR_KEY&gt; root@&lt;SERVER_IP&gt;:/root/.ssh/id_ed25519
$ scp ~/.ssh/&lt;YOUR_KEY&gt;.pub root@&lt;SERVER_IP&gt;:/root/.ssh/id_ed25519.pub
</code></pre><p>Then hit build and apply the config:</p>
<pre tabindex=0><code>$ nixos-rebuild switch \
  --flake .#peepeepoopoo \
  --target-host root@&lt;SERVER_IP&gt; \
  --build-host localhost
copying 3 paths...
copying path '/nix/store/lali119kww58c4df3b1w61yzg5an1mr7-system-units' to 'ssh://root@&lt;SERVER_IP&gt;'...
copying path '/nix/store/g1izspgbn34hmlll2hby5qapx90nm43p-etc' to 'ssh://root@&lt;SERVER_IP&gt;'...
copying path '/nix/store/739zphavd4d1vjfnd8v2b1bpm0dzwxz6-nixos-system-unnamed-22.05.20221024.6107f97' to 'ssh://root@&lt;SERVER_IP&gt;'...
updating GRUB 2 menu...
stopping the following units: emojied.service
activating the configuration...
[agenix] creating new generation in /run/agenix.d/1
[agenix] decrypting secrets...
decrypting '/root/secrets/emojiedDBCACert.age' to '/run/agenix.d/1/emojiedDBCACert'...
decrypting '/root/secrets/emojiedDBPassword.age' to '/run/agenix.d/1/emojiedDBPassword'...
[agenix] symlinking new secrets to /run/agenix (generation 1)...
[agenix] chowning...
setting up /etc...
reloading user units for root...
setting up tmpfiles
starting the following units: emojied.service
the following new units were started: run-agenix.d.mount
</code></pre><p>Which gives me this beautiful creation:</p>
<figure>
<img loading=lazy src=/posts/p4-emojied.png alt="The abomination now works!"> <figcaption>
<p>The abomination now works!</p>
</figcaption>
</figure>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://blog.sekun.dev/tags/nix/>nix</a></li>
<li><a href=https://blog.sekun.dev/tags/flakes/>flakes</a></li>
</ul>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2022 <a href=https://blog.sekun.dev>sekun's blog</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>